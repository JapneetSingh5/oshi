<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>SolarisOperatingSystem.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">oshi-demo</a> &gt; <a href="../index.html" class="el_bundle">oshi-core</a> &gt; <a href="index.source.html" class="el_package">oshi.software.os.unix.solaris</a> &gt; <span class="el_source">SolarisOperatingSystem.java</span></div><h1>SolarisOperatingSystem.java</h1><pre class="source lang-java linenums">/**
 * MIT License
 *
 * Copyright (c) 2010 - 2020 The OSHI Project Contributors: https://github.com/oshi/oshi/graphs/contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package oshi.software.os.unix.solaris;

import static oshi.software.os.OSService.State.RUNNING;
import static oshi.software.os.OSService.State.STOPPED;

import java.io.File;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;

import com.sun.jna.platform.unix.solaris.LibKstat.Kstat; // NOSONAR squid:S1191

import oshi.annotation.concurrent.ThreadSafe;
import oshi.driver.linux.proc.ProcessStat;
import oshi.driver.unix.solaris.Who;
import oshi.jna.platform.unix.solaris.SolarisLibc;
import oshi.software.common.AbstractOperatingSystem;
import oshi.software.os.FileSystem;
import oshi.software.os.InternetProtocolStats;
import oshi.software.os.NetworkParams;
import oshi.software.os.OSProcess;
import oshi.software.os.OSService;
import oshi.software.os.OSSession;
import oshi.util.ExecutingCommand;
import oshi.util.LsofUtil;
import oshi.util.ParseUtil;
import oshi.util.platform.unix.solaris.KstatUtil;
import oshi.util.platform.unix.solaris.KstatUtil.KstatChain;

/**
 * Solaris is a non-free Unix operating system originally developed by Sun
 * Microsystems. It superseded the company's earlier SunOS in 1993. In 2010,
 * after the Sun acquisition by Oracle, it was renamed Oracle Solaris.
 */
@ThreadSafe
public class SolarisOperatingSystem extends AbstractOperatingSystem {

<span class="nc" id="L62">    private static final long BOOTTIME = querySystemBootTime();</span>

    /**
     * &lt;p&gt;
     * Constructor for SolarisOperatingSystem.
     * &lt;/p&gt;
     */
    @SuppressWarnings(&quot;deprecation&quot;)
<span class="nc" id="L70">    public SolarisOperatingSystem() {</span>
<span class="nc" id="L71">        this.version = new SolarisOSVersionInfoEx();</span>
<span class="nc" id="L72">    }</span>

    @Override
    public String queryManufacturer() {
<span class="nc" id="L76">        return &quot;Oracle&quot;;</span>
    }

    @Override
    public FamilyVersionInfo queryFamilyVersionInfo() {
<span class="nc" id="L81">        String[] split = ParseUtil.whitespaces.split(ExecutingCommand.getFirstAnswer(&quot;uname -rv&quot;));</span>
<span class="nc" id="L82">        String version = split[0];</span>
<span class="nc" id="L83">        String buildNumber = null;</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (split.length &gt; 1) {</span>
<span class="nc" id="L85">            buildNumber = split[1];</span>
        }
<span class="nc" id="L87">        return new FamilyVersionInfo(&quot;SunOS&quot;, new OSVersionInfo(version, &quot;Solaris&quot;, buildNumber));</span>
    }

    @Override
    protected int queryBitness(int jvmBitness) {
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (jvmBitness == 64) {</span>
<span class="nc" id="L93">            return 64;</span>
        }
<span class="nc" id="L95">        return ParseUtil.parseIntOrDefault(ExecutingCommand.getFirstAnswer(&quot;isainfo -b&quot;), 32);</span>
    }

    @Override
    protected boolean queryElevated() {
<span class="nc bnc" id="L100" title="All 2 branches missed.">        return System.getenv(&quot;SUDO_COMMAND&quot;) != null;</span>
    }

    @Override
    public FileSystem getFileSystem() {
<span class="nc" id="L105">        return new SolarisFileSystem();</span>
    }

    @Override
    public InternetProtocolStats getInternetProtocolStats() {
<span class="nc" id="L110">        return new SolarisInternetProtocolStats();</span>
    }

    @Override
    public List&lt;OSSession&gt; getSessions() {
<span class="nc bnc" id="L115" title="All 2 branches missed.">        return Collections.unmodifiableList(USE_WHO_COMMAND ? super.getSessions() : Who.queryUtxent());</span>
    }

    @Override
    public OSProcess[] getProcesses(int limit, ProcessSort sort, boolean slowFields) {
<span class="nc" id="L120">        List&lt;OSProcess&gt; procs = getProcessListFromPS(</span>
                &quot;ps -eo s,pid,ppid,user,uid,group,gid,nlwp,pri,vsz,rss,etime,time,comm,args&quot;, -1, slowFields);
<span class="nc" id="L122">        List&lt;OSProcess&gt; sorted = processSort(procs, limit, sort);</span>
<span class="nc" id="L123">        return sorted.toArray(new OSProcess[0]);</span>
    }

    @Override
    public OSProcess getProcess(int pid, boolean slowFields) {
<span class="nc" id="L128">        List&lt;OSProcess&gt; procs = getProcessListFromPS(</span>
                &quot;ps -o s,pid,ppid,user,uid,group,gid,nlwp,pri,vsz,rss,etime,time,comm,args -p &quot;, pid, slowFields);
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (procs.isEmpty()) {</span>
<span class="nc" id="L131">            return null;</span>
        }
<span class="nc" id="L133">        return procs.get(0);</span>
    }

    @Override
    public OSProcess[] getChildProcesses(int parentPid, int limit, ProcessSort sort) {
<span class="nc" id="L138">        List&lt;OSProcess&gt; procs = getProcessListFromPS(</span>
                &quot;ps -eo s,pid,ppid,user,uid,group,gid,nlwp,pri,vsz,rss,etime,time,comm,args --ppid&quot;, parentPid, true);
<span class="nc" id="L140">        List&lt;OSProcess&gt; sorted = processSort(procs, limit, sort);</span>
<span class="nc" id="L141">        return sorted.toArray(new OSProcess[0]);</span>
    }

    private List&lt;OSProcess&gt; getProcessListFromPS(String psCommand, int pid, boolean slowFields) {
<span class="nc" id="L145">        Map&lt;Integer, String&gt; cwdMap = LsofUtil.getCwdMap(pid);</span>
<span class="nc" id="L146">        List&lt;OSProcess&gt; procs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        List&lt;String&gt; procList = ExecutingCommand.runNative(psCommand + (pid &lt; 0 ? &quot;&quot; : pid));</span>
<span class="nc bnc" id="L148" title="All 4 branches missed.">        if (procList.isEmpty() || procList.size() &lt; 2) {</span>
<span class="nc" id="L149">            return procs;</span>
        }
        // remove header row
<span class="nc" id="L152">        procList.remove(0);</span>
        // Fill list
<span class="nc bnc" id="L154" title="All 2 branches missed.">        for (String proc : procList) {</span>
<span class="nc" id="L155">            String[] split = ParseUtil.whitespaces.split(proc.trim(), 15);</span>
            // Elements should match ps command order
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (split.length &lt; 15) {</span>
<span class="nc" id="L158">                continue;</span>
            }
<span class="nc" id="L160">            long now = System.currentTimeMillis();</span>
<span class="nc" id="L161">            OSProcess sproc = new OSProcess(this);</span>
<span class="nc bnc" id="L162" title="All 6 branches missed.">            switch (split[0].charAt(0)) {</span>
            case 'O':
<span class="nc" id="L164">                sproc.setState(OSProcess.State.RUNNING);</span>
<span class="nc" id="L165">                break;</span>
            case 'S':
<span class="nc" id="L167">                sproc.setState(OSProcess.State.SLEEPING);</span>
<span class="nc" id="L168">                break;</span>
            case 'R':
            case 'W':
<span class="nc" id="L171">                sproc.setState(OSProcess.State.WAITING);</span>
<span class="nc" id="L172">                break;</span>
            case 'Z':
<span class="nc" id="L174">                sproc.setState(OSProcess.State.ZOMBIE);</span>
<span class="nc" id="L175">                break;</span>
            case 'T':
<span class="nc" id="L177">                sproc.setState(OSProcess.State.STOPPED);</span>
<span class="nc" id="L178">                break;</span>
            default:
<span class="nc" id="L180">                sproc.setState(OSProcess.State.OTHER);</span>
                break;
            }
<span class="nc" id="L183">            sproc.setProcessID(ParseUtil.parseIntOrDefault(split[1], 0));</span>
<span class="nc" id="L184">            sproc.setParentProcessID(ParseUtil.parseIntOrDefault(split[2], 0));</span>
<span class="nc" id="L185">            sproc.setUser(split[3]);</span>
<span class="nc" id="L186">            sproc.setUserID(split[4]);</span>
<span class="nc" id="L187">            sproc.setGroup(split[5]);</span>
<span class="nc" id="L188">            sproc.setGroupID(split[6]);</span>
<span class="nc" id="L189">            sproc.setThreadCount(ParseUtil.parseIntOrDefault(split[7], 0));</span>
<span class="nc" id="L190">            sproc.setPriority(ParseUtil.parseIntOrDefault(split[8], 0));</span>
            // These are in KB, multiply
<span class="nc" id="L192">            sproc.setVirtualSize(ParseUtil.parseLongOrDefault(split[9], 0) * 1024);</span>
<span class="nc" id="L193">            sproc.setResidentSetSize(ParseUtil.parseLongOrDefault(split[10], 0) * 1024);</span>
            // Avoid divide by zero for processes up less than a second
<span class="nc" id="L195">            long elapsedTime = ParseUtil.parseDHMSOrDefault(split[11], 0L);</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">            sproc.setUpTime(elapsedTime &lt; 1L ? 1L : elapsedTime);</span>
<span class="nc" id="L197">            sproc.setStartTime(now - sproc.getUpTime());</span>
<span class="nc" id="L198">            sproc.setUserTime(ParseUtil.parseDHMSOrDefault(split[12], 0L));</span>
<span class="nc" id="L199">            sproc.setPath(split[13]);</span>
<span class="nc" id="L200">            sproc.setName(sproc.getPath().substring(sproc.getPath().lastIndexOf('/') + 1));</span>
<span class="nc" id="L201">            sproc.setCommandLine(split[14]);</span>
<span class="nc" id="L202">            sproc.setCurrentWorkingDirectory(cwdMap.getOrDefault(sproc.getProcessID(), &quot;&quot;));</span>
            // bytes read/written not easily available

<span class="nc bnc" id="L205" title="All 2 branches missed.">            if (slowFields) {</span>
<span class="nc" id="L206">                List&lt;String&gt; openFilesList = ExecutingCommand.runNative(String.format(&quot;lsof -p %d&quot;, pid));</span>
<span class="nc" id="L207">                sproc.setOpenFiles(openFilesList.size() - 1L);</span>

<span class="nc" id="L209">                List&lt;String&gt; pflags = ExecutingCommand.runNative(&quot;pflags &quot; + pid);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                for (String line : pflags) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                    if (line.contains(&quot;data model&quot;)) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                        if (line.contains(&quot;LP32&quot;)) {</span>
<span class="nc" id="L213">                            sproc.setBitness(32);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                        } else if (line.contains(&quot;LP64&quot;)) {</span>
<span class="nc" id="L215">                            sproc.setBitness(64);</span>
                        }
                        break;
                    }
<span class="nc" id="L219">                }</span>
            }
<span class="nc" id="L221">            procs.add(sproc);</span>
<span class="nc" id="L222">        }</span>
<span class="nc" id="L223">        return procs;</span>
    }

    @Override
    public long getProcessAffinityMask(int processId) {
<span class="nc" id="L228">        long bitMask = 0L;</span>
<span class="nc" id="L229">        String cpuset = ExecutingCommand.getFirstAnswer(&quot;pbind -q &quot; + processId);</span>
        // Sample output:
        // &lt;empty string if no binding&gt;
        // pid 101048 strongly bound to processor(s) 0 1 2 3.
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (cpuset.isEmpty()) {</span>
<span class="nc" id="L234">            List&lt;String&gt; allProcs = ExecutingCommand.runNative(&quot;psrinfo&quot;);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">            for (String proc : allProcs) {</span>
<span class="nc" id="L236">                String[] split = ParseUtil.whitespaces.split(proc);</span>
<span class="nc" id="L237">                int bitToSet = ParseUtil.parseIntOrDefault(split[0], -1);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (bitToSet &gt;= 0) {</span>
<span class="nc" id="L239">                    bitMask |= 1L &lt;&lt; bitToSet;</span>
                }
<span class="nc" id="L241">            }</span>
<span class="nc" id="L242">            return bitMask;</span>
<span class="nc bnc" id="L243" title="All 4 branches missed.">        } else if (cpuset.endsWith(&quot;.&quot;) &amp;&amp; cpuset.contains(&quot;strongly bound to processor(s)&quot;)) {</span>
<span class="nc" id="L244">            String parse = cpuset.substring(0, cpuset.length() - 1);</span>
<span class="nc" id="L245">            String[] split = ParseUtil.whitespaces.split(parse);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            for (int i = split.length - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L247">                int bitToSet = ParseUtil.parseIntOrDefault(split[i], -1);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                if (bitToSet &gt;= 0) {</span>
<span class="nc" id="L249">                    bitMask |= 1L &lt;&lt; bitToSet;</span>
                } else {
                    // Once we run into the word processor(s) we're done
                    break;
                }
            }
        }
<span class="nc" id="L256">        return bitMask;</span>
    }

    @Override
    public int getProcessId() {
<span class="nc" id="L261">        return SolarisLibc.INSTANCE.getpid();</span>
    }

    @Override
    public int getProcessCount() {
<span class="nc" id="L266">        return ProcessStat.getPidFiles().length;</span>
    }

    @Override
    public int getThreadCount() {
<span class="nc" id="L271">        List&lt;String&gt; threadList = ExecutingCommand.runNative(&quot;ps -eLo pid&quot;);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (!threadList.isEmpty()) {</span>
            // Subtract 1 for header
<span class="nc" id="L274">            return threadList.size() - 1;</span>
        }
<span class="nc" id="L276">        return getProcessCount();</span>
    }

    @Override
    public long getSystemUptime() {
<span class="nc" id="L281">        return querySystemUptime();</span>
    }

    private static long querySystemUptime() {
<span class="nc" id="L285">        try (KstatChain kc = KstatUtil.openChain()) {</span>
<span class="nc" id="L286">            Kstat ksp = kc.lookup(&quot;unix&quot;, 0, &quot;system_misc&quot;);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">            if (ksp != null) {</span>
                // Snap Time is in nanoseconds; divide for seconds
<span class="nc" id="L289">                return ksp.ks_snaptime / 1_000_000_000L;</span>
            }
<span class="nc bnc" id="L291" title="All 2 branches missed.">        }</span>
<span class="nc" id="L292">        return 0L;</span>
    }

    @Override
    public long getSystemBootTime() {
<span class="nc" id="L297">        return BOOTTIME;</span>
    }

    private static long querySystemBootTime() {
<span class="nc" id="L301">        try (KstatChain kc = KstatUtil.openChain()) {</span>
<span class="nc" id="L302">            Kstat ksp = kc.lookup(&quot;unix&quot;, 0, &quot;system_misc&quot;);</span>
<span class="nc bnc" id="L303" title="All 4 branches missed.">            if (ksp != null &amp;&amp; kc.read(ksp)) {</span>
<span class="nc" id="L304">                return KstatUtil.dataLookupLong(ksp, &quot;boot_time&quot;);</span>
            }
<span class="nc bnc" id="L306" title="All 2 branches missed.">        }</span>
<span class="nc" id="L307">        return System.currentTimeMillis() / 1000L - querySystemUptime();</span>
    }

    @Override
    public NetworkParams getNetworkParams() {
<span class="nc" id="L312">        return new SolarisNetworkParams();</span>
    }

    @Override
    public OSService[] getServices() {
<span class="nc" id="L317">        List&lt;OSService&gt; services = new ArrayList&lt;&gt;();</span>
        // Get legacy RC service name possibilities
<span class="nc" id="L319">        List&lt;String&gt; legacySvcs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L320">        File dir = new File(&quot;/etc/init.d&quot;);</span>
        File[] listFiles;
<span class="nc bnc" id="L322" title="All 6 branches missed.">        if (dir.exists() &amp;&amp; dir.isDirectory() &amp;&amp; (listFiles = dir.listFiles()) != null) {</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">            for (File f : listFiles) {</span>
<span class="nc" id="L324">                legacySvcs.add(f.getName());</span>
            }
        }
        // Iterate service list
<span class="nc" id="L328">        List&lt;String&gt; svcs = ExecutingCommand.runNative(&quot;svcs -p&quot;);</span>
        /*-
         Output:
         STATE          STIME    FRMI
         legacy_run     23:56:49 lrc:/etc/rc2_d/S47pppd
         legacy_run     23:56:49 lrc:/etc/rc2_d/S81dodatadm_udaplt
         legacy_run     23:56:49 lrc:/etc/rc2_d/S89PRESERVE
         online         23:56:25 svc:/system/early-manifest-import:default
         online         23:56:25 svc:/system/svc/restarter:default
                        23:56:24       13 svc.startd
                        ...
         */
<span class="nc bnc" id="L340" title="All 2 branches missed.">        for (String line : svcs) {</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">            if (line.startsWith(&quot;online&quot;)) {</span>
<span class="nc" id="L342">                int delim = line.lastIndexOf(&quot;:/&quot;);</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">                if (delim &gt; 0) {</span>
<span class="nc" id="L344">                    String name = line.substring(delim + 1);</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                    if (name.endsWith(&quot;:default&quot;)) {</span>
<span class="nc" id="L346">                        name = name.substring(0, name.length() - 8);</span>
                    }
<span class="nc" id="L348">                    services.add(new OSService(name, 0, STOPPED));</span>
                }
<span class="nc bnc" id="L350" title="All 2 branches missed.">            } else if (line.startsWith(&quot; &quot;)) {</span>
<span class="nc" id="L351">                String[] split = ParseUtil.whitespaces.split(line.trim());</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                if (split.length == 3) {</span>
<span class="nc" id="L353">                    services.add(new OSService(split[2], ParseUtil.parseIntOrDefault(split[1], 0), RUNNING));</span>
                }
<span class="nc bnc" id="L355" title="All 2 branches missed.">            } else if (line.startsWith(&quot;legacy_run&quot;)) {</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                for (String svc : legacySvcs) {</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">                    if (line.endsWith(svc)) {</span>
<span class="nc" id="L358">                        services.add(new OSService(svc, 0, STOPPED));</span>
<span class="nc" id="L359">                        break;</span>
                    }
<span class="nc" id="L361">                }</span>
            }
<span class="nc" id="L363">        }</span>
<span class="nc" id="L364">        return services.toArray(new OSService[0]);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>